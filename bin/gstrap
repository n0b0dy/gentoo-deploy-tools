#!/bin/sh
STAGE3_PATH=""
PORTAGE_PATH=""
EXTRACT_PATH="."
V_FLAG="Y";
VERSION=0.4.3 
dl_bg(){
  url="${1}"
  extract_path="${2}"
  name="$(basename $url)"
  fifo_path="/tmp/gstrap_fifo"
  if test -p "${fifo_path}";then rm -f "${fifo_path}" ;fi
  mkfifo $fifo_path
  ( wget --progress=dot -O-  $url  2> $fifo_path | tar -C "${extract_path}" -xpjf - & )
  echo -n "Download: ${name}     "
  cat ${fifo_path} | grep --line-buffered "%" | sed -u -e "s,\.,,g" | awk '{printf("\b\b\b\b\b%5s", $2)}'
  echo "\b\b\b\b"
  rm -f "${fifo_path}"
}

dl_s(){
url="${1}"
extract_path="${2}"
wget -O- $url | tar -C "${extract_path}" -xpjf -
}

stage3_download(){
  mkdir -p $EXTRACT_PATH
  if [ "${V_FLAG}" = "Y" ];then
    dl_s  $STAGE3_PATH $EXTRACT_PATH
  else
    dl_bg $STAGE3_PATH $EXTRACT_PATH
  fi
}

portage_download() {
  mkdir -p "${EXTRACT_PATH}/usr"
  if [ "${V_FLAG}" = "Y" ];then
    dl_s  $PORTAGE_PATH "${EXTRACT_PATH}/usr"
  else
    dl_bg $PORTAGE_PATH "${EXTRACT_PATH}/usr"
  fi
}


usage(){ 
	echo "Usage:
  ${0##*/} [options] [extract path]"
	cat <<EOF

Application Options:
  -s <name>    stage3
  -p <name>    portage list
  -q           simple progress

Version: $VERSION
Licence: GNU GPL version 3 <http://www.gnu.org/licenses/gpl.html>
EOF
}
 
if [ "$#" -eq 0 ]; then usage;exit 1;fi
ARGS=$(getopt -n ${0##*/} -o 'hvs:p:' -- "$@")
eval set -- "$ARGS"
while [ "$1" != -- ]; do
    case "$1" in
        -p) PORTAGE_PATH=$2;shift;;
        -s) STAGE3_PATH=$2;shift;;
        -q) V_FLAG='N';;
        -h) usage;exit 0;;
    esac
    shift
done

shift $(expr $# - 1) 
if [ -z "$1" ] || [ "$1"=="--" ]; then
    usage
    exit 1
fi
EXTRACT_PATH=$1
####################################################

EXTRACT_PATH=$(echo $EXTRACT_PATH | sed 's/\/$//')
####################################################
if [ -n "$STAGE3_PATH" ]; then
	stage3_download;
fi

if [ -n "$PORTAGE_PATH" ]; then
	portage_download;
fi
echo "DONE"
exit 0

