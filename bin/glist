#!/bin/bash
DEF_MIRROR="http://mirror.yandex.ru/gentoo-distfiles/"
DEF_ARCH="amd64"
E_OPTERR=65
SNFLAG=N
SFLAGS=0
PFLAGS=0
ENVFLAG=N
VERSION=0.5.0
path_f=$(readlink -f -- ${0} | sed -e 's:/[^/]*/[^/]*$::')
. $path_f/function


stage3_list(){
  url=$1
  arch=$2
  filter=$3
  stage3_path="/releases/$arch/current-stage3/"
  slist=$(wget -qO - $url$stage3_path | sed -ne "s/.*href=\"\(.*stage.*bz2\)\".*/\1/p")
  protocol_url=$(echo "$slist"| head -n1 | sed -ne "s/^\(http\|ftp\)\:.*/\1/p")
  if [ -z "$protocol_url" ]; then
    slist=$( echo "$slist" | sed -ne "s|^|$url$stage3_path|p")
  fi
  show_result "$slist" "$filter"
}

portage_list() {
  url="$1"
  filter="$2"
  portage_path='/snapshots/'
  plist=$(wget -qO - $url$portage_path | sed -ne "s/.*href=\"\(.*portage-.*bz2\)\".*/\1/p")
  protocol_url=$(echo "$plist"| head -n1 | sed -ne "s/^\(http\|ftp\)\:.*/\1/p")
  #Надо подумать
  if [ -z "$protocol_url" ]; then
    plist=$(echo "$plist"| sed -ne "s|^|$url$portage_path|p")
  fi
  #sed -ne "s/^\(http\|ftp\)\:.*/\1/p"   показать протокол из url
  show_result "$plist" "$filter"
  #sed -ne "s/.*href=\"\(.*portage-.*bz2\)\".*/\1/p" для ftp
}

show_result(){
  list=$1
  filter=$2
  if [ "$SNFLAG" = "Y" ]; then
    list=$(echo "$list" | sed '/./=' | sed '/./N; s/\n/ /')
  fi
  
  if [ -n "$filter" ]; then
    echo "$list" | sed -n "$filter p"
  else
    echo "$list"
  fi
}

usage(){ 
echo "Usage:
  ${0##*/} [options]"
cat <<EOF

Application Options:
  -s    Stage3 list flag
  -p    Portage list flag
  -a    Set achitecture x86, amd64
  -n    Show numbers
  -m    Set mirror
  -e    export enviroment
  -h    Show help options

Version: $VERSION
Licence: GNU GPL version 3 <http://www.gnu.org/licenses/gpl.html>
EOF
}


if [ "$#" -eq 0 ]; then usage;exit 1;fi
#getopt parser
ARGS=$(getopt -n ${0##*/} -o 'ehns::p::a:m:' -- "$@")
eval set -- "$ARGS"


while [ "$1" != -- ]; do
    case "$1" in
        -p) FPORTAGE=$2;PFLAGS=1;shift;;
        -s) FSTAGE3=$2;SFLAGS=1;shift;;
        -n) SNFLAG=Y;;
        -a) ARCH=$2;shift;;
        -m) MIRROR=$2;shift;;
        -e) ENVFLAG=Y;;
        -h) usage;exit 0;;
    esac
    shift
done

#define system architecture
if [ -z "$ARCH" ];then
ARCH=$DEF_ARCH
march=$(uname -m )
  case $march in
    x86_64) ARCH="amd64";;
    i686|i586) ARCH="x86";;
  esac
fi


#check mirror params
if [ -z "$MIRROR" ];then
  ENV_READ "MIRROR"
  if [ -z "$MIRROR" ];then
    MIRROR=$(echo $DEF_MIRROR | sed 's/\/$//')
  fi
fi

if [ "$SFLAGS" -eq 1 ];then
    STAGE3=$(stage3_list "$MIRROR" "$ARCH" "$FSTAGE3")
    echo "${STAGE3}"
fi

if [ "$PFLAGS" -eq 1 ];then
    PORTAGE=$(portage_list "$MIRROR" "$FPORTAGE")
    echo "${PORTAGE}"
fi
if [ "$ENVFLAG" = "Y" ];then
    ENV_CLEAR
    ENV_SAVE "MIRROR STAGE3 PORTAGE"
fi
exit 0
