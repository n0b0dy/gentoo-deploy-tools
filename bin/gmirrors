#!/bin/bash
MIRROR_URL="www.gentoo.org/main/en/mirrors3.xml"
PROTOCOL="http"
SNFLAG=N
ENV_FLAG=N
SEARCH=''
VERSION=0.5.0

path_f=$(readlink -f -- ${0} | sed -e 's:/[^/]*/[^/]*$::')
. $path_f/function

usage(){ 
  echo "Usage:
  ${0##*/} [options]"
  cat <<EOF

Application Options:
  -p    protocol ftp, http, rsync
  -s    search mirror
  -n    show line numbe
  -e    export enviroment mirror 
  -h    help

Version: $VERSION
Licence: GNU GPL version 3 <http://www.gnu.org/licenses/gpl.html>
EOF
exit 0
}

mirror_list(){
  protocol=$1
  search=$2
  mlist=$(wget -qO - $MIRROR_URL | grep '<uri' | sed -e 's/<[^>]*>//g' | sed -e 's/^\s*//g' | sed -ne "/^\($protocol\)/p"  | sort) 

  if [ -n "$search" ]; then
      mlist=$(echo "$mlist" | sed -n "$search p")
  fi
  
  if [ "$ENV_FLAG" = "Y" ];then
    ENV_CLEAR
    MIRROR=$(echo "${mlist}" | sed -ne 1p)
    ENV_SAVE "MIRROR"
  fi
 
  if [ "$SNFLAG" = "Y" ]; then
       mlist=$(echo "$mlist" | sed '/./=' | sed '/./N; s/\n/ /')
  fi
      
  echo "${mlist}"
}


ARGS=$(getopt -n $(basename "$0") -o 'enhp:s::' -- "$@")

eval set -- "$ARGS"

while [ "$1" != -- ]
do
    case "$1" in
       -p) PROTOCOL=$(echo $2 | sed -e 's/,/\\\|/g');shift;;
       -s) SEARCH=$2; shift;;
       -n) SNFLAG=Y;;
       -e) ENV_FLAG=Y;;
       -h) usage;;
       --) shift;break;;
       -*) usage;;
        *) break;;            #better be the crawl directory
    esac
    shift
done
shift

mirror_list $PROTOCOL $SEARCH
exit 0

